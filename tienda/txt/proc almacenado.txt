//	Agregar producto a existencia

DELIMITER $$
	CREATE PROCEDURE actualizar_precio_producto (n_cantidad int, n_precio decimal(10,2), codigo int)
	BEGIN
		DECLARE nueva_existencia int;
		DECLARE nuevo_total decimal (10, 2);
		DECLARE nuevo_precio decimal (10, 2);
        
		DECLARE cant_actual int;
		DECLARE pre_actual decimal (10, 2);
        
		DECLARE actual_existencia int;
		DECLARE actual_precio decimal(10,2);
        
        SELECT precio,existencia INTO actual_precio,actual_existencia FROM producto WHERE cod_producto = codigo;
		SET nueva_existencia = actual_existencia + n_cantidad;
		SET nuevo_total = (actual_existencia * actual_precio) + (n_cantidad * n_precio);
		SET nuevo_precio = nuevo_total / nueva_existencia;
        
		UPDATE producto SET existencia = nueva_existencia, precio = nuevo_precio WHERE cod_producto = codigo;
        
		SELECT nueva_existencia, nuevo_precio;
        
	END;$$
DELIMITER ;

//===============================================================================//


//	Agregar a la tabla "detalle_temp"

DELIMITER $$
CREATE PROCEDURE add_detalle_temp(codigo int, cantidad int, token_user varchar(50))
	BEGIN

		DECLARE precio_actual decimal(10,2);
		SELECT precio INTO precio_actual FROM producto WHERE cod_producto = codigo;

		INSERT INTO detalle_temp(token_user, cod_producto, cantidad, precio_actual) VALUE(token_user, codigo, cantidad, precio_actual);

		SELECT tmp.correlativo, tmp.cod_producto, tmp.descripcion, tmp.cantidad, tmp.precio_actual FROM detalle_temp tmp
		INNER JOIN producto
		ON tmp.cod_producto = p.cod_producto
		WHERE tmp.token_user = token_user;

	END;$$
DELIMITER ;

//===============================================================================//